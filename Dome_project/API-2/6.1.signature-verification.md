# 加签与验签机制

加签与验签机制是保障您的应用与 **[喵福禄][喵福禄]** 之间的数据交互是安全的重要手段。它能够:

1. 确保请求的真实性: 验证请求确实来自 **[喵福禄][喵福禄]** ，而非恶意第三方。
2. 保证数据完整性: 确保数据在传输过程中未被篡改。
3. 防止重放攻击: 通过时间戳等机制，防止请求被重复使用。

## 应用场景

<!-- TODO: 应用授权并未使用它

### 应用授权

在您开始使用 **[喵福禄][喵福禄]** 的 REST API 之前，您需要先对接应用授权流程。在这个过程中，加签与验签机制是确保请求合法性的重要环节。
详细内容请参阅：[应用授权](./2.authentication.md) 。

-->

### Webhooks通知

当您配置的 Webhooks 事件触发时， **[喵福禄][喵福禄]** 会向您的配置的 Webhook 地址推送 HTTP POST 请求。在推送这些数据时， **[喵福禄][喵福禄]** 会对数据进行签名处理。
您收到请求后，可通过验证签名来验证数据的合法性，以确保请求的真实性和数据完整性。详细内容请参阅：[Webhooks通知](7.webhooks.md)。

## 签名算法

**[喵福禄][喵福禄]** 使用 HMAC-SHA256 算法对 HTTP 请求数据进行签名。这种验证机制广泛应用于 API 安全，有效的确保请求的完整性和真实性。

HMAC-SHA256 是一种结合了哈希消息认证码（HMAC）和 SHA-256 哈希函数的安全算法，它是基于散列函数的消息认证码，由以下两个算法组成：

- [HMAC(Hash-based Message Authentication Code][hmac]
- [SHA-256(Secure Hash Algorithm 256-bit)][sha-2]

## 获取 App Secret

在 **[喵福禄][喵福禄]** 的应用管理页面，点击 `创建应用` 获取 `App ID` 与 `App Secret`。

如果您已经创建了应用，忘记了 `App Secret` ，那么您需要点击 `重置密钥` 按钮以获取新的 `App Secret` 。 更多详情请参阅：[快速开始][快速开始]。

> ⚠️ 注意：
> 
> 如果您的应用更新了 `App Secret` ，您应该使用最新的 `App Secret` 进行签名。


## 数据加签与验签

### Header 签名参数:

Header 签名参数适用于 **[喵福禄][喵福禄]** 支持的所有请求方式，用于签名验证。当然，如果您正在使用 Query 请求，您也可以将这些参数放在 Query 参数中，更多详情请参阅：[Query 签名参数](#query-签名参数)

- `X-Meowflow-Timestamp`: 时间戳(13位，毫秒)
- `X-Meowflow-Signature`: 签名

### Query 签名参数:

Query 请求是指使用 GET 或 DELETE 方法发送的请求

Query 参数仅在 Query 请求中使用，用于签名验证。当然，您也可以将这些参数放在 Header 中，更多详细内容请参阅：[Header 签名参数](#header-签名参数)

- `meowflow_timestamp`: 时间戳(13位，毫秒)
- `meowflow_signature`: 签名

> 温馨提示：
>
> 当涉及 Query 参数加签数据时，您可以根据自己的需求选择将参数放在 Header 中还是 Query 中。
> 如果您同时在 Header 和 Query 中传递了相同的参数，那么 **[喵福禄][喵福禄]** 会优先使用 Query 中的参数。
> 
> 在签名验证时，您需要优先从 Query 参数中检出 [Query 签名参数](#query-签名参数) 进行验证。
> 如果 Query 参数中没有签名相关参数，那么您需要尝试使用 [Header 签名参数](#header-签名参数) 进行验证。 


### Query 请求

Query 请求是指使用 GET 或 DELETE 方法发送的请求

#### Query 签名流程

签名内容格式: `{HTTPMethod} {Domain}{Path}?{sortedQueryString}`

1. 构造待签名字符串
   1. Method: HTTP 请求方法
   2. 空格: 分隔 Method 和 Domain
   3. Domain: HTTP 请求 Domain (Host + Port(非 80/443))
   4. Path: HTTP 请求路径
   5. 如果 Query 参数包含 `meowflow_signature`，则需要将其排除在签名计算之外
   6. Query 参数需要包含 `meowflow_timestamp` 参数，且该参数的值与 `X-Meowflow-Timestamp` 的值相同
   7. 按照字典序排序的 Query 参数的 Key
   8. Query 参数的 Key 和 Value 之间使用 `=` 连接，多个 Value 之间使用 `,` 连接
   9. 多个 Query 参数之间使用 `&` 连接
   11. 使用 ? + Query 参数字符串拼接为待签名字符串
2. 借助 `App Secret` 对待签名字符串使用 HMAC-SHA256 算法进行签名



<img src="./6.signature-verification.assets/image-20240916130202355.png" alt="image-20240916130202355" style="zoom:50%;" />



上诉流程图中 source 为 **`"GET example.com/api?a=1&b=d&c=a&meowflow_timestamp=1693497601234&z=abc`**


#### 发送 Query 请求

在 [需要加签的应用场景](#应用场景) 下，如果您尝试向 **[喵福禄][喵福禄]** 发送 Query 请求时，您需要在请求中包含签名相关的参数。您可以选择将参数放在 Header 中或 Query 中。

1. 使用 Header 参数发送请求

   当您发送请求时，您需要在请求头中包含 [Header 签名参数](#header-签名参数)

   您可以使用以下示例代码来发送请求：

   ```bash
   curl -X GET "https://example.com/api?a=1&b=d&c=a&z=abc" \
   -H "X-Meowflow-Timestamp: <TIMESTAMP_MILLI>" \
   -H "X-Meowflow-Signature: <SIGNATURE>"
   ```

2. 使用 Query 参数发送请求

   当您发送请求时，您需要在请求 URL 中包含 [Query 签名参数](#query-签名参数)

   您可以使用以下示例代码来发送请求：

   ```bash
   curl -X GET "https://example.com/api?b=d&c=a&a=1&meowflow_timestamp=<TIMESTAMP_MILLI>&z=abc&meowflow_signature=<SIGNATURE>"
   ```


#### 接收 Query 请求

在 [需要验签的应用场景](#应用场景) 下，当 **[喵福禄][喵福禄]** 向您的应用程序推送数据时，您需要验证签名以确保请求的真实性和数据完整性。

1. 请您参阅 [Query 签名流程](#query-签名流程) 对请求参数进行处理并得到待签名字符串
2. 借助 `App Secret` 对待签名字符串使用 HMAC-SHA256 算法进行签名
3. 将签名结果与原请求中的签名进行比对，如果一致，则请求合法，否则认为请求不合法


### Body 请求

Body 请求是指使用 POST、PUT 或 PATCH 方法发送的请求

#### Body 签名流程

签名内容格式: `{HTTPMethod} {Domain}{Path} {Body}{Timestamp}`

1. 构造待签名字符串
   1. Method: HTTP 请求方法
   2. 空格: 分隔 Method 和 Domain
   3. Domain: HTTP 请求 Domain (Host + Port(非 80/443))
   4. Path: HTTP 请求路径
   5. " " + 请求体的原始内容 + timestamp 拼接为待签名字符串
2. 借助 `App Secret` 对待签名字符串使用 HMAC-SHA256 算法进行签名



<img src="./6.signature-verification.assets/image-20240915204748596.png" alt="image-20240915204748596" style="zoom:50%;" />



上诉流程图中 source 为 **`"POST example.com/api {\"b\":\"d\",\"c\":\"a\",\"a\":1}1693497601234"`**


#### 发送 Body 请求

在 [需要加签的应用场景](#应用场景) 下，如果您尝试向 **[喵福禄][喵福禄]** 发送 Body 请求时，您需要在请求头中包含 [Header 签名参数](#header-签名参数)

您可以使用以下示例代码来发送请求：

```bash
curl -X POST "https://example.com/api" \
   -H "Content-Type: application/json" \
   -H "X-Meowflow-Timestamp: <TIMESTAMP_MILLI>" \
   -H "X-Meowflow-Signature: <SIGNATURE>" \
   -d '{"b":1,"a":"d","z":"d"}'
```


#### 接收 Body 请求

在 [需要验签的应用场景](#应用场景) 下，当 **[喵福禄][喵福禄]** 向您的应用程序推送数据时，您需要验证签名以确保请求的真实性和数据完整性。

1. 请您参阅 [Body 签名流程](#body-签名流程) 对请求参数进行处理并得到待签名字符串
2. 借助 `App Secret` 对待签名字符串使用 HMAC-SHA256 算法进行签名
3. 将签名结果与原请求中的签名进行比对，如果一致，则请求合法，否则认为请求不合法



> 温馨提示：
>
> [喵福禄][喵福禄] 的签名时间戳有效期为 5 分钟，即请求时间戳与当前时间戳的差值不超过 5 分钟。
> 
> 您应该验证请求的时间戳，以防止重放攻击。您可以在签名验证时检查时间戳是否在有效期内。如果时间戳不在有效期内，则拒绝该请求。
> 
> 当您向 **[喵福禄][喵福禄]** 发送请求时，您的时间戳应该与 **[喵福禄][喵福禄]** 的时间戳相差不超过 5 分钟。否则，请求将被拒绝。



## 示例代码

更多示例代码请参阅：[签名与验签示例代码](6.2.signature-verification-codes-example.md)


[喵福禄]: https://meowflow.com.cn/ "喵福禄"

[快速开始]: ./1.quick-start.md#快速开始    "快速开始"

[hmac]: https://en.wikipedia.org/wiki/HMAC

[sha-2]: https://en.wikipedia.org/wiki/SHA-2

[Spring Boot]: https://spring.io/projects/spring-boot "Spring Boot"

[Laravel]: https://laravel.com/ "Laravel"

[Symfony]: https://symfony.com/ "Symfony"

[Flask]: https://flask.palletsprojects.com/ "Flask"

[Express]: https://expressjs.com/ "Express"

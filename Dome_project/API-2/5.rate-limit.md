# REST API 速率限制

为了保障 **[喵福禄][喵福禄]** 服务的稳定运行和各用户之间资源的公平分配，REST API 实施了一些速率限制措施。以防止恶意请求或者过度使用
API 资源，我们深知这可能会给您带来一些不便，但请相信这是为了给所有用户提供更好的服务体验。
我们希望开发者在使用 REST API 时，需要遵守速率限制规则，有效地限制调用和合理地进行重试请求，以避免因频繁请求而导致的 API 调用失败。
让我们一起来了解一下这些规则，以便您能更好地使用我们的 REST API。

## 速率限制策略

速率限制是指在一定时间内允许的 REST API 请求次数。我们采用了一种叫做 ["令牌桶算法"（Token Bucket Algorithm）][Token Bucket] 的策略。
这个算法很有趣，它可以让您在一段时间内灵活地使用 REST API，而不是严格限制每秒的请求数。

### 速率限制的具体细节

为了帮助您更好地规划 API 使用，我们为您准备了一些具体的数字供参考：

- REST API 是按分钟来计算速率限制的。
- 每个 APP 的速率限制是独立的，互不影响。
- 默认情况下，每个 APP 每分钟可以发送 60 次请求，每秒钟会"补充"2 次请求机会。

如果不小心超过了限制，API 会返回 `429 Too Many Requests` 错误。请不用担心，这是很常见的情况！

为了帮助您更好地管理请求，每次 API 响应时， **[喵福禄][喵福禄]** 都会在 HTTP 头信息中提供以下信息：

- `X-RateLimit-Limit`：您的速率限制最大值。
- `X-RateLimit-Remaining`：您还剩下的请求机会次数。

如果遇到 `429 Too Many Requests` 错误，REST API 还会告诉您：

- `Retry-After`：需要等待多少秒才能继续请求。

## 关于获取 Access Token 的特别说明

获取 Access Token 的规则稍有不同，我们为您列出了具体细节：

- 每个 APP 每分钟最多可以请求 20 次。
- 同一时间段内，最多可以有 10 个有效的 Access Token。如果超过这个数量，您可能会收到 `429 Too Many Requests` 错误，这时您可以尝试等待一段时间再次请求。

## 喵福禄的"喵喵币"系统：生动解释令牌桶算法

想象下，现在 **喵福禄** 化身为一家神奇的猫咖，我们使用"喵喵币"来管理访客流量。这就像令牌桶算法的工作方式：

#### 喵喵币系统（令牌桶）运作规则

1. 我们有一个"喵喵币储蓄罐"，最多可存60枚喵喵币。（令牌桶最大容量）
2. 每秒钟，我们会往储蓄罐里添加2枚新的喵喵币，直到达到上限。（令牌桶填充速率）
3. 每位访客进入时需要借用一枚喵喵币。（API请求）
4. 访客离开时，会归还喵喵币，但储蓄罐不会超过最大容量。（API请求完成）
5. 如果储蓄罐里有喵喵币，访客可以立即进入；如果没有，需要等待。（请求速率限制：`429 Too Many Requests`）

#### 一天中的喵咖时光

让我们看看在不同时段，猫咖是如何运作的：

1. 早晨开业（桶满状态）：
   - 9:00，猫咖开门，储蓄罐里有60枚喵喵币。
   - 来了20位访客，他们借走20枚喵喵币入场，储蓄罐还剩40枚。

2. 正常运作（动态平衡）：
   - 9:01-9:30，每秒都有2枚新喵喵币加入储蓄罐。
   - 新访客陆续到来，借走喵喵币；早来的访客离开，归还喵喵币。
   - 储蓄罐的喵喵币数量在动态变化，但始终有喵喵币可用。

3. 突发高峰（令牌快速消耗）：
   - 10:00，突然涌入50位访客！
   - 储蓄罐里的喵喵币快速减少，刚好被全部借走。
   - 服务员微笑着说："欢迎光临，请享受您的时光~"
   - 这体现出令牌桶算法的灵活特性，可以应对突发的流量高峰。

4. 超出限制（令牌耗尽）：
   - 10:01，又来了20位访客，但储蓄罐已经空了。
   - 服务员歉意地说："非常抱歉，请稍等片刻，我们正在等待喵喵币归还或生成新的~"
   - 这相当于触发了`429 Too Many Requests`错误。

5. 逐渐恢复（令牌重新积累）：
   - 10:02开始，一些早先的访客离开，归还了喵喵币。
   - 同时，每秒也在添加2枚新喵喵币。
   - 等候的访客可以逐渐入场，但有些访客可能需要等待几秒。
   - 服务员解释道："感谢您的耐心，很快就能为您服务~"

6. 平稳期（动态平衡恢复）：
   - 10:10后，进出访客数量趋于平衡。
   - 归还的喵喵币和新生成的喵喵币能够满足新访客的需求。
   - 储蓄罐中的喵喵币数量在一个相对稳定的范围内波动。

#### 友好提示

每次访客"光临"时，我们都会告诉 Ta：
- 储蓄罐还剩多少喵喵币（`X-RateLimit-Remaining`：剩余令牌数）
- 储蓄罐最多能存多少喵喵币（`X-RateLimit-Limit`：令牌桶容量）

如果需要等待，我们会告诉 Ta 大约要等多久（`Retry-After`：预计等待时间）。

这个"喵喵币"系统帮助我们在应对突发高峰时保持灵活，同时确保长期的稳定服务。它模拟了API请求的动态特性，既考虑了新请求的到来，也考虑了旧请求的完成。

> 这就是 **[喵福禄][喵福禄]** REST API 速率限制的工作原理。我们希望通过这个生动的例子，能让您更容易理解这个概念。


[喵福禄]: https://meowflow.com.cn/ "喵福禄"

[Token Bucket]: https://en.wikipedia.org/wiki/Token_bucket

